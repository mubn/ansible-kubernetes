---
- hosts: kubernetes
  become: true
  roles:
    - os
    - geerlingguy.ntp
    - docker
    - access

- hosts: kubernetes
  become: true
  tasks:
  - name: Fetch public keys
    fetch:
      flat: true
      src: '/home/{{ cluster_user }}/.ssh/id_rsa.pub'
      dest: '/tmp/id_rsa_{{ inventory_hostname }}.pub'

- hosts: kubernetes
  become: true
  tasks:
  - name: Add public keys to authorized_keys
    authorized_key:
      user: '{{ cluster_user }}'
      key: '{{ lookup("file", "/tmp/id_rsa_" + inventory_hostname + ".pub") }}'

- hosts: kubernetes
  become: true
  become_user: '{{ cluster_user }}'
  roles:
    - rke-ansible
